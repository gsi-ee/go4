include Makefile.config

GO4PACKAGE = go4taskhandler

GO4BASE_LIBNAME = $(LIB_PREFIX)Go4Base
GO4BASE_SLIB    = $(GO4DLLPATH)/$(GO4BASE_LIBNAME).$(DllSuf)
GO4BASE_LIB     = $(GO4BASE_SLIB).$(VERSSUF)

THRDMNGR_LIBNAME= $(LIB_PREFIX)Go4ThreadManager
THRDMNGR_SLIB   = $(GO4DLLPATH)/$(THRDMNGR_LIBNAME).$(DllSuf)
THRDMNGR_LIB    = $(THRDMNGR_SLIB).$(VERSSUF)

GO4TSKH_LIBNAME = $(LIB_PREFIX)Go4TaskHandler
GO4TSKH_SLIB    = $(GO4DLLPATH)/$(GO4TSKH_LIBNAME).$(DllSuf)
GO4TSKH_LIB     = $(GO4TSKH_SLIB).$(VERSSUF)

BUILDGO4LIBS = $(GO4BASE_LIB) \
               $(THRDMNGR_LIB) \
               $(GO4TSKH_LIB)

MODULES  = Go4Exceptions Go4LockGuard Go4Log \
           Go4ThreadManager Go4ThreadManagerExample \
           Go4Queue Go4Socket Go4StatusBase \
           Go4CommandsBase Go4CommandsTaskHandler \
           Go4TaskHandler Go4TaskHandlerExample

EXMODULES = Go4ThreadManagerExample Go4TaskHandlerExample 

all:          libs map examples 

.PHONY:         all libs examples map \
                clean clean-ex clean-bak clean-obj package \
                $(patsubst %,all-%,$(MODULES)) \
                $(patsubst %,clean-%,$(MODULES)) \
                $(patsubst %,clean-obj-%,$(MODULES))

include $(patsubst %,%/Module.mk,$(MODULES))


build/dummy.d: Makefile $(ALLHDRS) 
	@(if [ ! -f $@ ] ; then touch $@; fi)
	@(if [ ! -f lib ] ; then mkdir -p lib; fi)
	@(if [ ! -f bin ] ; then mkdir -p bin; fi)

libs:        $(BUILDGO4LIBS)         

examples:    $(patsubst %,all-%,$(EXMODULES)) $(EXAMPLEEXECS)

map:         $(GO4MAP)
ifndef DOMAP
	@echo "Map for task handler classes can not be generated with ROOT $(shell root-config --version)"
endif

clean:     $(patsubst %,clean-%,$(MODULES))
	@rm -f $(GO4MAP)
	@$(CleanLib) $(GO4BASE_LIBNAME) $(GO4DLLPATH)
	@$(CleanLib) $(GO4TSKH_LIBNAME) $(GO4DLLPATH)
	@echo "Clean go4 taskhandeler done"

clean-obj: $(patsubst %,clean-obj-%,$(MODULES))
	@$(CleanLib) $(GO4BASE_LIBNAME) $(GO4DLLPATH)
	@$(CleanLib) $(GO4TSKH_LIBNAME) $(GO4DLLPATH)
	@echo "Clean go4 taskhandeler object files done"

clean-ex:  $(patsubst %,clean-%,$(EXMODULES))
	@echo "Clean taskhandeler examples done"

clean-bak:
	@echo "Delete bak files"
	@rm -f $(patsubst %,%/*.bak,$(MODULES))
	@rm -f $(patsubst %,%/*.*~,$(MODULES))

GO4BASE_O = $(LOCKGRD_O) $(LOCKGRD_DO) \
            $(GO4LOG_O) $(GO4LOG_DO) \
            $(EXCEPT_O) \
            $(COMBASE_O) $(COMBASE_DO) \
            $(STATBASE_O) $(STATBASE_DO)

GO4TSKH_O = $(GO4SOCKET_O) \
            $(GO4QUEUE_O) \
            $(TASKHAND_O) $(TASKHAND_DO) \
            $(CMDTASKHANDL_O) $(CMDTASKHANDL_DO)

$(GO4BASE_LIB):   $(GO4BASE_O)
		@$(MakeLib) $(GO4BASE_LIBNAME) "$(GO4BASE_O)" $(GO4DLLPATH)

$(THRDMNGR_LIB):   $(THRDMNGR_O) $(THRDMNGR_DO)
		@$(MakeLib) $(THRDMNGR_LIBNAME) "$(THRDMNGR_O) $(THRDMNGR_DO)" $(GO4DLLPATH)

$(GO4TSKH_LIB):   $(GO4TSKH_O)
		@$(MakeLib) $(GO4TSKH_LIBNAME) "$(GO4TSKH_O)" $(GO4DLLPATH)

ifdef DOMAP

GO4MAPDEPLIST = $(GO4SYS)/Go4LockGuard/Go4LockGuardLinkDef.h \
                $(GO4SYS)/Go4Log/Go4LogLinkDef.h \
                $(GO4SYS)/Go4CommandsBase/Go4CommandsBaseLinkDef.h \
                $(GO4SYS)/Go4StatusBase/Go4StatusBaseLinkDef.h \
                $(GO4SYS)/Go4ThreadManager/Go4ThreadManagerLinkDef.h \
                $(GO4SYS)/Go4TaskHandler/Go4TaskHandlerLinkDef.h

GO4MAPDEPLIBS = $(GO4BASE_LIB) $(THRDMNGR_LIB) $(GO4TSKH_LIB)
                
$(GO4MAP): $(GO4MAPDEPLIST) $(GO4MAPDEPLIBS)
	@rm -f $(GO4MAP)
	@echo "Producing $(GO4MAP) file"
	@$(MakeMap) $(GO4MAP) $(GO4BASE_SLIB) $(GO4SYS)/Go4LockGuard/Go4LockGuardLinkDef.h "$(BASIC_LIB_DEP)"
	@$(MakeMap) $(GO4MAP) $(GO4BASE_SLIB) $(GO4SYS)/Go4Log/Go4LogLinkDef.h "$(BASIC_LIB_DEP)"
	@$(MakeMap) $(GO4MAP) $(GO4BASE_SLIB) $(GO4SYS)/Go4CommandsBase/Go4CommandsBaseLinkDef.h "$(BASIC_LIB_DEP)"
	@$(MakeMap) $(GO4MAP) $(GO4BASE_SLIB) $(GO4SYS)/Go4StatusBase/Go4StatusBaseLinkDef.h "$(BASIC_LIB_DEP)"
	@$(MakeMap) $(GO4MAP) $(THRDMNGR_SLIB) $(GO4SYS)/Go4ThreadManager/Go4ThreadManagerLinkDef.h "$(GO4BASE_SLIB) $(BASIC_LIB_DEP)"
	@$(MakeMap) $(GO4MAP) $(GO4TSKH_SLIB) $(GO4SYS)/Go4TaskHandler/Go4TaskHandlerLinkDef.h "$(THRDMNGR_SLIB) $(GO4BASE_SLIB) $(BASIC_LIB_DEP)"
	@echo "Map of go4 task handler classes is done"
else
$(GO4MAP):
	@echo "Go4 task handler map can not be generated"
endif

include Makefile.rules

ifeq ($(findstring $(MAKECMDGOALS), $(FASTRULES)),)
-include build/dummy.d
endif
